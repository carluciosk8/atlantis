#include "city.h"

#include "hud.h"
#include "lane.h"
#include "score.h"
#include "sprites.h"
#include "tiles.h"

#include <mplayer.h>


const uint8_t map_background[] =
{
    0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x7B,0x7C,
    0x77,0x78,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x2C,0x2D,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x23,0x2C,0x2D,
    0x22,0x3A,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x3D,0x22,0x22,0x3A,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x3D,0x22,
    0x22,0x3B,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x7E,0x22,0x22,0x3C,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x3E,0x22,
    0x22,0x22,0x5C,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x7E,0x22,0x22,0x22,0x22,0x5E,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x7E,0x7D,0x22,0x22,
    0x22,0x22,0x5B,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x3E,0x22,0x22,0x22,0x22,0x5B,0x21,0x5D,0x21,0x21,0x21,0x21,0x5D,0x21,0x5F,0x22,0x22,0x22,0x22,
    0x22,0x22,0x3C,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x3F,0x22,0x22,0x22,0x22,0x22,0x7D,0x22,0x5C,0x21,0x21,0x21,0x3F,0x22,0x22,0x22,0x22,0x22,0x22,
    0x22,0x22,0x3B,0x21,0x21,0x21,0x21,0x21,0x3E,0x22,0x22,0x22,0x7D,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x5B,0x21,0x21,0x21,0x3E,0x22,0x22,0x22,0x22,0x22,0x22,
    0x22,0x22,0x22,0x5E,0x21,0x21,0x21,0x5F,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x3B,0x21,0x21,0x21,0x3F,0x22,0x22,0x22,0x22,0x22,0x22,
    0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x3C,0x21,0x21,0x21,0x3F,0x22,0x22,0x22,0x22,0x22,0x22,
    0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x5C,0x21,0x21,0x3E,0x22,0x22,0x22,0x22,0x22,0x22,
};

const uint8_t map_water_anim[4][12] =
{
    {0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80},
    {0x81,0x81,0x81,0x81,0x81,0x81,0x81,0x81,0x81,0x81,0x81,0x81},
    {0x82,0x82,0x82,0x82,0x82,0x82,0x82,0x82,0x82,0x82,0x82,0x82},
    {0x83,0x83,0x83,0x83,0x83,0x83,0x83,0x83,0x83,0x83,0x83,0x83},
};

const uint8_t map_acropolis_command[] = {0x79,0x7A};
const uint8_t map_generator_aqua[] =    {0x84};
const uint8_t map_generator_air[] =     {0x88};
const uint8_t map_aqua_plain[] =        {0x1D,0x1E,0x1F};
const uint8_t map_domed_palace[] =      {0x28,0x29,0x2A,0x2B};
const uint8_t map_bridged_bazaar[] =    {0x24,0x25,0x26,0x27};

const uint8_t* map_installations_tiles[] =    { map_acropolis_command,  map_aqua_plain,  map_domed_palace,  map_generator_aqua,  map_generator_air,  map_bridged_bazaar,  map_generator_aqua };
const uint8_t  map_installations_size[] =     { 2,                      3,               4,                 1,                   1,                  4,                   1                  };
const uint8_t  map_installations_x[] =        { 120,                    36,              72,                100,                 130,                178,                 220                };
const uint8_t  map_installations_y[] =        { 84,                     153,             138,               114,                 100,                127,                 114                };
      uint8_t  map_have_installation[] =      { 1,                      1,               1,                 1,                   1,                  1,                   1                  };
const uint8_t* map_installations_address[] = 
{
    TILES_MAKE_ADDRESS(15, 0, map_background),
    TILES_MAKE_ADDRESS(4,  8, map_background),
    TILES_MAKE_ADDRESS(8,  6, map_background),
    TILES_MAKE_ADDRESS(13, 3, map_background),
    TILES_MAKE_ADDRESS(17, 1, map_background),
    TILES_MAKE_ADDRESS(21, 5, map_background),
    TILES_MAKE_ADDRESS(28, 3, map_background)
};
const uint8_t* map_installations_vaddress[] =
{
    TILES_MAKE_ADDRESS(15, 12, 0x1800),
    TILES_MAKE_ADDRESS(4,  20, 0x1800),
    TILES_MAKE_ADDRESS(8,  18, 0x1800),
    TILES_MAKE_ADDRESS(13, 15, 0x1800),
    TILES_MAKE_ADDRESS(17, 13, 0x1800),
    TILES_MAKE_ADDRESS(21, 17, 0x1800),
    TILES_MAKE_ADDRESS(28, 15, 0x1800)
};

uint8_t map_state = MAP_STATE_IDLE;
uint8_t map_explosion_counter = 0;


void map_init()
{
    ubox_disable_screen();
    ubox_set_colors(1,1,7);
    ubox_fill_screen(35);
    TILES_PUT_BUFFER(0, 12, map_background, sizeof(map_background));
    TILES_PUT_BUFFER(0, 23, hud, 32);

    map_create_instalation(MAP_ACROPOLIS_COMMAND_ID);
    map_create_instalation(MAP_AUQA_PLAINS_ID);
    map_create_instalation(MAP_DOMED_PALACE_ID);
    map_create_instalation(MAP_GENERATOR_AQUA1_ID);
    map_create_instalation(MAP_GENERATOR_AIR_ID);
    map_create_instalation(MAP_BRIDGED_BAZAAR_ID);
    map_create_instalation(MAP_GENERATOR_AQUA2_ID);

    ubox_enable_screen();
}

void map_create_instalation(uint8_t index)
{
    ubox_write_vm((uint8_t*)map_installations_vaddress[index], map_installations_size[index], (uint8_t*)map_installations_tiles[index]);
    map_have_installation[index] = 1;
}


void map_destroy_instalation(uint8_t index)
{
    ubox_write_vm((uint8_t*)map_installations_vaddress[index], map_installations_size[index], (uint8_t*)map_installations_address[index]);
    map_have_installation[index] = 0;
    g_is_attacking = 0;
    sprites_disable_deathray();
    mplayer_play_effect_p(5, 0, 0);
}


void map_start_explosion(uint8_t x, uint8_t y)
{
    sprites_attributes[15].x = x;
    sprites_attributes[16].x = x;
    sprites_attributes[15].y = y;
    sprites_attributes[16].y = y;
    sprites_attributes[15].attr = 9;
    sprites_attributes[16].attr = 11;
    sprites_attributes[15].pattern = sprites_explosion_anim1[0];
    sprites_attributes[16].pattern = sprites_explosion_anim2[0];
    map_explosion_counter = 0;
    map_state = MAP_STATE_EXPLODING;
}


void map_update()
{
    uint8_t four_frames_count = (ubox_tick % 16) >> 2;
    uint8_t two_frames_count = four_frames_count >> 1;
 
    if (map_have_installation[4]) ubox_put_tile(17, 13, map_generator_air[0] + two_frames_count);
    if (map_have_installation[3]) ubox_put_tile(13, 15, map_generator_aqua[0] + four_frames_count);
    if (map_have_installation[6]) ubox_put_tile(28, 15, map_generator_aqua[0] + four_frames_count);

    ubox_write_vm((uint8_t*)TILES_MAKE_ADDRESS(2,  14, 0x1800), 12, map_water_anim[four_frames_count]);
    ubox_write_vm((uint8_t*)TILES_MAKE_ADDRESS(18, 14, 0x1800), 12, map_water_anim[four_frames_count]);

    if (map_state == MAP_STATE_EXPLODING)
    {
        uint8_t g_buildings_explosion_frame = map_explosion_counter >> 2;
        if (g_buildings_explosion_frame > 4)
        {
            map_state = MAP_STATE_IDLE;
            sprites_attributes[15].attr = 0;
            sprites_attributes[16].attr = 0;
        }
        else
        {
            sprites_attributes[15].pattern = sprites_explosion_anim1[g_buildings_explosion_frame];
            sprites_attributes[16].pattern = sprites_explosion_anim2[g_buildings_explosion_frame];
            map_explosion_counter++;
        }
    }
}
